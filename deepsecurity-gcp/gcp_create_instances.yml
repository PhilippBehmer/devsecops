---
- name: Create an instance
  debugger: on_failed
  hosts: localhost
  gather_facts: no
  connection: local

  vars_files:
    - ../../vars/secrets.yml
    - ../../vars/gcp.yml
  vars:
    scopes:
      - https://www.googleapis.com/auth/compute

  tasks:
    - name: create a disk
      gcp_compute_disk:
        name: 'disk-instance-linux-webserver'
        size_gb: 10
        source_image: 'projects/ubuntu-os-cloud/global/images/family/ubuntu-1804-lts'
        zone: "{{ zone }}"
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes:
          - https://www.googleapis.com/auth/compute
        state: present
      register: disk_linux_webserver
    - name: create a disk
      gcp_compute_disk:
        name: 'disk-instance-windows-webserver'
        size_gb: 50
        source_image: 'projects/windows-cloud/global/images/family/windows-2012-r2'
        zone: "{{ zone }}"
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes:
          - https://www.googleapis.com/auth/compute
        state: present
      register: disk_windows_webserver

    - name: create a network
      gcp_compute_network:
        name: 'network-instance'
        auto_create_subnetworks: yes
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
        state: present
      register: network

    - name: create a firewall
      gcp_compute_firewall:
        name: ansible-firewall
        network: "projects/{{ project_id }}/global/networks/{{ network.name }}"
        allowed:
          - ip_protocol: tcp
            ports: ['80', '443', '22', '3389', '5986','5985']
        target_tags:
          - webserver
        source_ranges: ['0.0.0.0/0']
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
        state: present
      register: firewall

    - name: create a linux webserver address
      gcp_compute_address:
        name: 'address-instance-linux-webserver'
        region: "{{ region }}"
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
        state: present
      register: address_linux_webserver
    - name: create a windows webserver address
      gcp_compute_address:
        name: 'address-instance-windows-webserver'
        region: "{{ region }}"
        project: "{{ project_id }}"
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
        state: present
      register: address_windows_webserver

    - name: create a linux instance
      gcp_compute_instance:
        state: present
        name: eu-gcp-web-1
        machine_type: n1-standard-1
        disks:
          - auto_delete: true
            boot: true
            source: "{{ disk_linux_webserver }}"
        metadata:
          startup-script: |
            #!/bin/sh
            apt update
            apt install -y python python-simplejson
        network_interfaces:
          - network: "{{ network }}"
            access_configs:
              - name: 'External NAT'
                nat_ip: "{{ address_linux_webserver }}"
                type: 'ONE_TO_ONE_NAT'
        zone: "{{ zone }}"
        project: "{{ project_id }}"
        tags:
          items:
            - "{{ project_id }}"
            - linux
            - webserver
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
      register: instance_linux_webserver
      
    - name: create a windows instance
      gcp_compute_instance:
        state: present
        name: eu-gcp-web-2
        machine_type: n1-standard-1
        disks:
          - auto_delete: true
            boot: true
            source: "{{ disk_windows_webserver }}"
        metadata:
          sysprep-specialize-script-ps1: |
            Invoke-Expression -Command ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1')); Enable-WSManCredSSP -Role Server -Force
        network_interfaces:
          - network: "{{ network }}"
            access_configs:
              - name: 'External NAT'
                nat_ip: "{{ address_windows_webserver }}"
                type: 'ONE_TO_ONE_NAT'
        zone: "{{ zone }}"
        project: "{{ project_id }}"
        tags:
          items:
            - "{{ project_id }}"
            - windows
            - webserver
        auth_kind: "{{ auth_kind }}"
        service_account_file: "{{ service_account_file }}"
        scopes: "{{ scopes }}"
      register: instance_windows_webserver

    - name: Check if Google Cloud SDK is installed
      command: gcloud version
      register: gcloud_installed
      changed_when: false
      ignore_errors: yes

    - fail:
        msg: "Please make sure Google Cloud SDK is installed before executing the role."
      when: gcloud_installed is failed

#    - name: Wait for WINRM to come up
#      win_wait_for:
#        host: "{{ address_windows_webserver }}"
#        port: 5986
#        delay: 10
#        timeout: 180
#      wait_for_connection:
#        timeout: 900

    - name: Create admin password
      command: gcloud beta compute --project "erudite-variety-209408" reset-windows-password "eu-gcp-web-2" --zone "europe-west3-c" --quiet
      register: username_password

    - name: Password
      debug:
        msg: "{{ username_password.stdout_lines[1] }}"
    - name: Username
      debug:
        msg: "{{ username_password.stdout_lines[2] }}"

    - name: Create subdirectory
      file:
        path: "./group_vars/tag_windows"
        state: directory

    - name: Configure group_vars for windows
      copy:
        dest: "./group_vars/tag_windows/ec-gcp-web-2"
        content: |
          ansible_connection: winrm
          ansible_port: 5986
          ansible_winrm_transport: ntlm
          ansible_winrm_server_cert_validation: ignore
          ansible_password: {{ username_password.stdout_lines[1] | regex_replace('password:') }}
          ansible_user: {{ username_password.stdout_lines[2] | regex_replace('username:') }}
      delegate_to: 127.0.0.1
